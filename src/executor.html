<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tauri App</title>
    <script type="module" src="/main.js" defer></script>
    <style>
      .logo.vanilla:hover {
        filter: drop-shadow(0 0 2em #ffe21c);
      }
    </style>
    <script type="module" defer>
        const { invoke } = window.__TAURI__.tauri;

        await invoke("executor_resize")
    </script>
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="_static/js/ext/monaco-editor/dev/vs/editor/editor.main.css">
  </head>

    <body>
        <script>
                fetch(`${document.location.protocol}//${document.location.host}/assets/keywords.json`).then(async resp => {
                window.keywords = await resp.json()
                })
                fetch(`${document.location.protocol}//${document.location.host}/assets/gruvbox.json`).then(async resp => {
                window.gruvbox = await resp.json()
                })
        </script>
        <script>var require = { paths: { 'vs': '_static/js/ext/monaco-editor/dev/vs' } };</script>
        <script src="_static/js/ext/monaco-editor/dev/vs/loader.js"></script>
        <script src="_static/js/ext/monaco-editor/dev/vs/editor/editor.main.nls.js"></script>
        <script src="_static/js/ext/monaco-editor/dev/vs/editor/editor.main.js"></script>


    <div class="executor-container">
        <div class="sidebar">
            <button class="sidebar-button" id="run">
                <img id="run-icon" src="/assets/play.svg" class="sidebar-icon"/>
            </button>
            <button class="sidebar-button" id="explore">
                <img id="explore-icon" src="/assets/folder-tree.svg" class="sidebar-icon"/>
            </button>
            <button class="sidebar-button sidebar-bottom" id="settings">
                <img id="settings-icon" src="/assets/settings.svg" class="sidebar-icon"/>
            </button>
        </div>
        <div class="explorer" id="explorer">
            <div class="explorer-entry" id="explorer-entry">
                <img id="explorer-icon" src="/assets/folder-open.svg" class="explorer-icon"/>
                <span id="explorer-text">folder1</span>
            </div>
            <div class="explorer-entry explorer-script" id="explorer-entry">
                <img id="explorer-icon" src="/assets/corner-down-right.svg" class="explorer-icon-arrow" style="margin-left: 8px;"/>
                <img id="explorer-icon" src="/assets/file-code-2.svg" class="explorer-icon-script" style="margin-top: 3px;"/>
                <span id="explorer-text" style="margin-top: 3px;">script.lua</span>
                
            </div>
            <div class="explorer-entry explorer-script" id="explorer-entry">
                <img id="explorer-icon" src="/assets/corner-down-right.svg" class="explorer-icon-arrow" style="margin-left: 8px;"/>
                <img id="explorer-icon" src="/assets/file-code-2.svg" class="explorer-icon-script" style="margin-top: 3px;"/>
                <span id="explorer-text" style="margin-top: 3px;">script.lua</span>
                
            </div>
            <div class="explorer-entry explorer-script" id="explorer-entry">
                <img id="explorer-icon" src="/assets/corner-down-right.svg" class="explorer-icon-arrow" style="margin-left: 8px;"/>
                <img id="explorer-icon" src="/assets/file-code-2.svg" class="explorer-icon-script" style="margin-top: 3px;"/>
                <span id="explorer-text" style="margin-top: 3px;">script.lua</span>
                
            </div>
        </div>
        <div class="output" id="output-container">
            <div class="output-header">
                Output
                <button class="output-button" id="clear-output">
                    <img id="clear-icon" src="/assets/eraser.svg" class="output-icon"/>
                </button>
            </div>
            <span class="output-text" id="base-output-text">2021-05-26 06:46:33 - hello world</span>
        </div>
        <div class="editor" id="editor-container">
                <script defer>
                    // CREATE AN EDITOR
                    const {fetch, Body} = window.__TAURI__.http;

                    var h_div = document.getElementById('editor-container');

                    const baseOutputText = document.getElementById("base-output-text")
                    const outputContainer = document.getElementById("output-container")
                    const clearOutputButton = document.getElementById("clear-output")
                    const runButton = document.getElementById("run")
                    const exploreButton = document.getElementById("explore")
                    const exploreDiv = document.getElementById("explorer")

                    let exploreOpen = false
                    let temporarySuggestions = []

                    baseOutputText.remove()

                    function print(text, type) {
                        const newText = baseOutputText.cloneNode()

                        newText.innerHTML = text
                        if(type){
                            newText.classList.add(type)
                        }

                        outputContainer.appendChild(newText)
                    }

                    monaco.editor.defineTheme("mshxTheme", {
                        base: "vs-dark",
                        inherit: true,
                        rules: gruvbox.rules,
                        colors: gruvbox.editor,
                        fontFamily: "Hack"
                    })

                    var editor = monaco.editor.create(h_div, {
                        value: "print('truly,')",
                        language: 'lua',
                        theme: "mshxTheme",
                        fontFamily: "Jetbrains Mono",
                        fontLigatures: true,
                        fontSize: 16
                    });

                    window.onresize = function (){
                        editor.layout();
                    };

                    monaco.languages.registerCompletionItemProvider('lua', {
                        provideCompletionItems: async (model, position) => {
                            const suggestions = window.keywords.concat(temporarySuggestions).map((keyword) => {
                                if(keyword.function){
                                    return {
                                        label: `${keyword.function}(${keyword.arguments}): ${keyword.returns}`,
                                        kind: monaco.languages.CompletionItemKind.Function,
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        insertText: `${keyword.function}(${keyword.arguments.replace(/: \w+/gm, "")}$0)`
                                    }
                                }else if(keyword.keyword){
                                    return {
                                        label: keyword.keyword,
                                        kind: monaco.languages.CompletionItemKind.Keyword,
                                        insertText: keyword.keyword
                                    }
                                }else if(keyword.method){
                                    return {
                                        label: keyword.method,
                                        kind: monaco.languages.CompletionItemKind.Method,
                                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                        insertText: `${keyword.method}${keyword.append}`
                                    }
                                }
                            });

                            return { suggestions: suggestions };
                        }
                    });

                    editor.onDidChangeModelContent((e) => {
                        temporarySuggestions = []

                        const text = editor.getValue()
                        const textLines = text.split("\n")
                        const lines = monaco.editor.tokenize(text, "lua")

                        let isFunctionIdentifer = false

                        lines.forEach((tokens, line) => {
                            tokens.forEach((token, index) => {

                                if(token.type == "identifier.lua"){
                                    if(isFunctionIdentifer){
                                        let length

                                        if(tokens[index+1]){
                                            length = tokens[index+1].offset - token.offset
                                        }

                                        console.log()
                                        temporarySuggestions.push({
                                            "function": textLines[line].substring(token.offset-1, length) || "",
                                            "arguments": "",
                                            "returns": ""
                                        })
                                        isFunctionIdentifer = false
                                    }else{
                                        let length

                                        if(tokens[index+1]){
                                            length = tokens[index+1].offset - token.offset
                                        }

                                        temporarySuggestions.push({
                                            "keyword": textLines[line].substring(token.offset-1, length) || ""
                                        })
                                    }
                                }else if(token.type == "keyword.function.lua"){
                                    isFunctionIdentifer = true
                                }
                            })
                        })
                    })

                    print("mushyhax on top!!", "success")
                    
                    clearOutputButton.onclick = () => {
                        while (document.getElementById("base-output-text")) {
                            outputContainer.removeChild(document.getElementById("base-output-text"));
                        }
                    }

                    exploreButton.onclick = () => {
                        exploreOpen = !exploreOpen

                        if(exploreOpen){
                            exploreDiv.style = "width: fit-content; height: calc(100% - 220px);"
                            exploreButton.style = "box-shadow: inset 0px 0px 0px 1px #396cd8;"
                        }else{
                            exploreDiv.style = "width: 0px; height: 0px; padding: 0px; left: 110%"
                            exploreButton.style = "box-shadow: none;"
                        }
                    }
                    exploreButton.onclick()

                    runButton.onclick = () => {
                        fetch("http://127.0.0.1:58280/add-to-queue", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: Body.text(editor.getValue())
                        })
                    }

                    const recursive = () => {
                        setTimeout(async () => {
                            try{
                                const data = await fetch("http://127.0.0.1:58280/read-message-queue")

                                data.data.forEach(item => {
                                    print(item[0], item[1])
                                })

                                recursive()
                            }catch(e){
                                print("failed to check for new output messages! (retrying in 1 minute) (is mushyhax running?)", "error")
                                setTimeout(recursive, 60000)
                            }
                        }, 100)
                    }

                    recursive()
                </script>
            </div>
        </div>
    </body>
</html>
